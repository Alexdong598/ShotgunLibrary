"""
Startup script for Shotgun Library UI in Houdini & Maya.
This script detects the host application (DCC) and launches the UI
using the appropriate method for each.
"""
from PySide2 import QtCore, QtWidgets

# This line is a specific requirement for your UI library. It was missing before.
# It ensures the script's execution context is set up as your UI expects.
if '__name__' not in globals():
    globals()['__name__'] = '__main__'

# --- Helper function ONLY for Maya's singleton ---
def get_maya_main_window():
    """Returns the Maya main window widget. Returns None if not in Maya."""
    try:
        from shiboken2 import wrapInstance
        import maya.OpenMayaUI as omui
        ptr = omui.MQtUtil.mainWindow()
        if ptr:
            return wrapInstance(int(ptr), QtWidgets.QWidget)
    except (ImportError, AttributeError):
        return None # This is expected to fail in Houdini

# --- Core UI Launch Logic ---
def create_new_ui_instance():
    """Creates one instance of the UI. This is called by the DCC-specific functions."""
    try:
        # Assumes your UI code is in a 'ui' module relative to this script.
        try:
            from .ui import execute
        except ImportError:
            from ui import execute

        window = execute()
        # This ensures the window is only hidden on close, not deleted.
        window.setAttribute(QtCore.Qt.WA_DeleteOnClose, False)
        return window
    except Exception as e:
        # The error you saw originates here if the __name__ fix is missing.
        print(f"Failed to create UI instance: {e}")
        return None

def launch_for_maya():
    """Robust singleton launcher for Maya."""
    maya_window = get_maya_main_window()
    if not maya_window:
        print("Error: Could not get Maya main window.")
        return

    # A unique name to store our UI instance on Maya's main window
    instance_attr = '_shotgun_library_instance'

    if hasattr(maya_window, instance_attr):
        print("Shotgun UI: Found existing instance. Showing it.")
        window_instance = getattr(maya_window, instance_attr)
        window_instance.show()
        window_instance.raise_()
        window_instance.activateWindow()
    else:
        print("Shotgun UI: No existing instance. Creating new one for Maya.")
        window_instance = create_new_ui_instance()
        if window_instance:
            # Store the new instance on the Maya window
            setattr(maya_window, instance_attr, window_instance)
            window_instance.show()

# --- Main Execution Block ---

def main():
    """
    Detects the DCC environment and runs the appropriate launcher.
    """
    # Condition 1: Check for Houdini üê¥
    try:
        import hou
        print("Houdini detected. Launching Shotgun Library UI.")
        # In Houdini, UI launch is typically direct.
        create_new_ui_instance()
        return # Stop execution, we are done.
    except ImportError:
        pass # Not in Houdini, continue to the next check.

    # Condition 2: Check for Maya üé®
    try:
        import maya.cmds as cmds
        # If 'maya.cmds' imports, we are in Maya.
        if not cmds.about(batch=True):
            print("Maya detected. Deferring Shotgun Library UI launch.")
            # Defer launch until Maya is idle to prevent startup issues.
            cmds.evalDeferred(launch_for_maya)
        return # Stop execution, we are done.
    except ImportError:
        pass # Not in Maya.

    print("Could not detect Houdini or Maya. Shotgun UI script will not run.")

# Run the main detection function
main()