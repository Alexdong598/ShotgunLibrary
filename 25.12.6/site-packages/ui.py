import importlib
import sys
from PySide2 import QtWidgets, QtCore, QtGui
import os
import ast
import json
import traceback
import re
from datetime import datetime
from collections import defaultdict

# --- DCC Integration ---
CURRENT_DCC = os.environ.get("DY_DCC")
try:
    if CURRENT_DCC == "Houdini":
        import hou
    elif CURRENT_DCC == "Maya":
        import maya.cmds as cmds
        import maya.mel as mel
except ImportError as e:
    print(f"Warning: Could not import libraries for {CURRENT_DCC}: {e}")

# --- ShotGrid Connection ---
try:
    from sg_register import login_to_shotgun
except ImportError:
    def login_to_shotgun():
        print("WARNING: 'sg_register.py' not found. ShotGrid connection will be mocked.")
        return None

# --- Custom Thumbnail Widget ---
class CustomThumbnailWidget(QtWidgets.QFrame):
    clicked = QtCore.Signal(QtWidgets.QWidget)
    def __init__(self, version_data, thumbnail_size, parent=None):
        super(CustomThumbnailWidget, self).__init__(parent)
        self.parent_ui = parent
        self.version_data = version_data
        self.thumbnail_size = thumbnail_size
        self.is_selected = False; self.hovered = False; self.is_dragging = False
        self.mouse_press_pos = None
        self.setMouseTracking(True); self.setAttribute(QtCore.Qt.WA_Hover)
        self.setFrameShape(QtWidgets.QFrame.Box); self.setFrameShadow(QtWidgets.QFrame.Raised)
        self.setLineWidth(1); self.setCursor(QtCore.Qt.PointingHandCursor)
        self.setAcceptDrops(True)
        self._setup_ui()
        self._update_style()

    def _setup_ui(self):
        layout = QtWidgets.QVBoxLayout(self)
        layout.setContentsMargins(5, 5, 5, 5); layout.setSpacing(2)
        self.thumb_label = QtWidgets.QLabel()
        self.thumb_label.setFixedSize(*self.thumbnail_size)
        self.thumb_label.setAlignment(QtCore.Qt.AlignCenter)
        image_path = self.version_data.get('image_path')
        if image_path and os.path.exists(image_path):
            pixmap = QtGui.QPixmap(image_path)
            if not pixmap.isNull():
                self.thumb_label.setPixmap(pixmap.scaled(self.thumb_label.size(), QtCore.Qt.KeepAspectRatio, QtCore.Qt.SmoothTransformation))
            else:
                self.thumb_label.setText("Invalid Image")
                self.thumb_label.setToolTip(f"Invalid image format at:\n{image_path}")
        else:
            self.thumb_label.setText("No Image")
            expected_prefix = self.version_data.get('image', 'N/A')
            self.thumb_label.setToolTip(f"Local file not found.\nExpected prefix: {expected_prefix}\nSearched path: {image_path or 'Not constructed'}")

        # Use the 'display_name' key, which is now reliably constructed by the main UI
        display_name = self.version_data.get('display_name', self.version_data.get('code', 'N/A'))
        self.name_label = QtWidgets.QLabel(display_name)
        self.name_label.setAlignment(QtCore.Qt.AlignCenter); self.name_label.setWordWrap(True)
        self.name_label.setToolTip(self.version_data.get('code', 'N/A')) # Tooltip shows full name

        layout.addWidget(self.thumb_label); layout.addWidget(self.name_label)

    def set_selected(self, selected: bool):
        self.is_selected = selected; self._update_style()

    def enterEvent(self, event: QtCore.QEvent):
        self.hovered = True; self._update_style(); super(CustomThumbnailWidget, self).enterEvent(event)

    def leaveEvent(self, event: QtCore.QEvent):
        self.hovered = False; self._update_style(); super(CustomThumbnailWidget, self).leaveEvent(event)

    def _update_style(self):
        if self.is_dragging: self.setStyleSheet("CustomThumbnailWidget{border:2px solid #4CAF50;background-color:#4a4a4a}QLabel{background-color:transparent;color:#cccccc}")
        elif self.is_selected: self.setStyleSheet("CustomThumbnailWidget{border:2px solid #427ab3;background-color:#404040}QLabel{background-color:transparent;color:#ffffff}")
        elif self.hovered: self.setStyleSheet("CustomThumbnailWidget{border:1px solid #777777;background-color:#3a3a3a}QLabel{background-color:transparent;color:#cccccc}")
        else: self.setStyleSheet("CustomThumbnailWidget{border:1px solid #555;background-color:#2a2a2a}QLabel{background-color:transparent;color:#cccccc}")

    def mousePressEvent(self, event: QtGui.QMouseEvent):
        if event.button() == QtCore.Qt.LeftButton:
            self.clicked.emit(self)
            self.mouse_press_pos = event.pos()
        super(CustomThumbnailWidget, self).mousePressEvent(event)

    def mouseMoveEvent(self, event: QtGui.QMouseEvent):
        if event.buttons() & QtCore.Qt.LeftButton and self.mouse_press_pos:
            if (event.pos() - self.mouse_press_pos).manhattanLength() >= QtWidgets.QApplication.startDragDistance():
                self._start_drag()
                self.mouse_press_pos = None
        super(CustomThumbnailWidget, self).mouseMoveEvent(event)

    def mouseReleaseEvent(self, event: QtGui.QMouseEvent):
        self.mouse_press_pos = None
        super(CustomThumbnailWidget, self).mouseReleaseEvent(event)

    # ui.py 里
    def _start_drag(self):
        # 先把右侧面板状态刷新到 drag_data
        QtWidgets.QApplication.processEvents()
        self.parent_ui.update_drag_info()
        drag_data = self.parent_ui.get_current_drag_data()

        file_path = drag_data.get('file_path')
        if not file_path or file_path == "N/A":
            # 没有有效路径就不开始拖拽
            return

        drag = QtGui.QDrag(self)
        mime_data = QtCore.QMimeData()

        if CURRENT_DCC == "Houdini":
            # —— B 方案：UI 只发“数据”而不是可执行脚本 ——
            # 用自定义 MIME：application/x-shotgun-library-data
            json_payload = json.dumps(drag_data)
            mime_data.setData("application/x-shotgun-library-data", json_payload.encode("utf-8"))
            # 兜底：也放一份纯文本路径，方便别的程序接住
            mime_data.setText(file_path)
        elif CURRENT_DCC == "Maya":
            # 保持原 Maya 行为：发文本脚本
            script = self.parent_ui.generate_maya_drop_script(drag_data)
            mime_data.setText(script)
        else:
            # 其他 DCC：仍按文件 URL 处理
            mime_data.setUrls([QtCore.QUrl.fromLocalFile(file_path)])

        drag.setMimeData(mime_data)
        try:
            self.is_dragging = True
            self._update_style()
            drag.exec_(QtCore.Qt.CopyAction)
        finally:
            self.is_dragging = False
            self._update_style()


# --- Hot-Reloading Logic ---
DEPENDENT_MODULE_NAMES = ["shotgun_data_manager", "sg_register"]
def execute():
    app = QtWidgets.QApplication.instance()
    if not app: app = QtWidgets.QApplication(sys.argv)

    for widget in app.allWidgets():
        if widget.objectName() == "shotgunLibraryUI_unique":
            print("Closing existing Shotgun Library UI instance.")
            widget.close()
            app.processEvents()

    for name in DEPENDENT_MODULE_NAMES:
        if name in sys.modules:
            importlib.reload(sys.modules[name])

    window = ShotgunLibraryUI()
    window.show()
    return window

# --- Helper Function ---
def get_main_host_window():
    try:
        import hou
        return hou.ui.mainQtWindow()
    except ImportError:
        try:
            from shiboken2 import wrapInstance
            import maya.OpenMayaUI as omui
            main_window_ptr = omui.MQtUtil.mainWindow()
            if main_window_ptr is not None:
                return wrapInstance(int(main_window_ptr), QtWidgets.QWidget)
        except (ImportError, AttributeError): pass
    return None

# --- Main UI Class ---
class ShotgunLibraryUI(QtWidgets.QWidget):
    ASSET_TYPES = ["mdl", "shd", "rig", "txt", "cgfx-setup", "cncpt","assy"]
    SHOT_TYPES = ["anim", "cgfx", "comp", "layout", "lgt", "mm", "matp", "paint", "roto","assy"]
    HAL_CATEGORY_TYPES = ["cgfx", "characters", "environments", "props", "vehicles"]
    THUMB_SIZES = [(80, 60), (100, 75), (120, 90), (160, 120), (200, 150), (240, 180)]
    DEFAULT_THUMB_SIZE_INDEX = 2
    NO_ASSET_FILTER_TAG = "不通过资产筛选"

# 文件: ui.py -> class ShotgunLibraryUI

    def __init__(self):
        parent_window = get_main_host_window()
        super(ShotgunLibraryUI, self).__init__(parent_window)
        self.setObjectName("shotgunLibraryUI_unique")
        self.setAttribute(QtCore.Qt.WA_DeleteOnClose)

        # --- MODIFICATION: 添加最小化和最大化按钮 ---
        # 我们不再使用 Qt.Tool 标志，而是显式设置一个带有所有标准按钮的窗口标志
        window_flags = QtCore.Qt.Window | QtCore.Qt.WindowMinimizeButtonHint | QtCore.Qt.WindowMaximizeButtonHint | QtCore.Qt.WindowCloseButtonHint
        self.setWindowFlags(window_flags)
        # --- END MODIFICATION ---

        self.setWindowTitle("Shotgun Library")
        self.resize(1200, 800)

        self.all_versions_for_context = []
        self.current_version_history = []
        self.shots_data = defaultdict(list)

        self.current_thumbnail_size = self.THUMB_SIZES[self.DEFAULT_THUMB_SIZE_INDEX]
        self.currently_selected_widget = None
        self.sg = None
        self.project_info = {'name': 'N/A', 'id': 'N/A'}
        self.current_drag_data = {}
        
        self.hal_task = os.environ.get("HAL_TASK", "")
        if not self.hal_task:
            print("Warning: HAL_TASK environment variable not set. Thumbnail names may be incomplete.")

        self._initialize_shotgun_connection()
        try:
            from shotgun_data_manager import ShotgunDataManager
            self.data_manager = ShotgunDataManager()
        except (ImportError, Exception) as e:
            print(f"Error initializing ShotgunDataManager: {e}. Using DummyDataManager.")
            class DummyDataManager:
                def find_files(self, tab_context=""): return []
            self.data_manager = DummyDataManager()

        self.setup_ui()
        self._on_main_tab_changed(0)
        
    def get_current_drag_data(self):
        return self.current_drag_data

    def update_drag_info(self):
        is_mm_context = False
        is_shot_tab = self.top_tab_bar.currentIndex() == 1

        if is_shot_tab and self.task_combo_shots.currentText() == 'mm':
            is_mm_context = True

        asset_filter_name = ""
        if self.asset_filter_widget.isVisible():
            asset_filter_name = self.asset_filter_combo.currentText()
            if asset_filter_name == self.NO_ASSET_FILTER_TAG:
                asset_filter_name = ""

        self.current_drag_data = {
            'version_name': self.material_combo.currentText(),
            'asset_filter_name': asset_filter_name,
            'file_path': self.file_path_label.text(),
            'format': self.render_combo.currentText(),
            'dcc': CURRENT_DCC,
            'is_mm_context': is_mm_context
        }

    def generate_maya_drop_script(self, data):
        json_data = json.dumps(data)
        python_command = f"""
import json
import maya.cmds as cmds
import os

def create_ai_volume_with_path(filename, desired_name=None):
    if not cmds.pluginInfo("mtoa", query=True, loaded=True):
        try:
            cmds.loadPlugin("mtoa")
        except Exception as e:
            cmds.error(f"Failed to load MtoA plugin: {{e}}")
            return None
    is_sequence = '$F' in filename or '####' in filename
    display_path = filename.replace('$F4', '####')
    try:
        volume_shape_name = cmds.createNode('aiVolume')
        if is_sequence:
            cmds.setAttr(f"{{volume_shape_name}}.useFrameExtension", 1)
        cmds.setAttr(f"{{volume_shape_name}}.filename", display_path, type="string")
        transform_name = cmds.listRelatives(volume_shape_name, parent=True, fullPath=True)[0]
        final_name = transform_name
        if desired_name:
            final_name = cmds.rename(transform_name, desired_name)
        cmds.select(final_name)
        return cmds.listRelatives(final_name, shapes=True, fullPath=True)[0]
    except Exception as e:
        cmds.error(f"An error occurred while creating aiVolume: {{e}}")
        return None

try:
    data = json.loads('{json_data}')
    file_path = data.get('file_path', '')
    file_format = data.get('format', '')
    asset_name = data.get('asset_filter_name')
    if not asset_name or asset_name == 'N/A':
        asset_name = data.get('version_name', 'imported_asset')
    if not file_path or file_path == 'N/A':
        raise Exception("No valid file path provided.")
    if file_format == 'vdb':
        create_ai_volume_with_path(file_path, desired_name=asset_name)
    elif file_format in ('usd', 'usda', 'usdc'):
        if not cmds.pluginInfo('mayaUsdPlugin', query=True, loaded=True):
            cmds.loadPlugin('mayaUsdPlugin')
        cmds.file(file_path, i=True, type='USD Import', ignoreVersion=True, namespace=asset_name, options='-primPath / -readAnimData true')
    elif file_format == 'abc':
        if not cmds.pluginInfo('AbcImport', query=True, loaded=True):
            cmds.loadPlugin('AbcImport')
        cmds.AbcImport(file_path, mode='import')
    elif file_format in ('ma', 'mb'):
        cmds.file(file_path, i=True, ignoreVersion=True, groupReference=True, groupName=asset_name)
    else:
        cmds.warning(f"Unsupported file format: '{{file_format}}'")
except Exception as e:
    import traceback
    print(traceback.format_exc())
    cmds.error(f"Failed to import file: {{e}}")
"""
        escaped_command = python_command.replace('\\', '\\\\').replace('"', '\\"').replace('\n', '\\n')
        return f'python("{escaped_command}");'

    def generate_houdini_mm_drop_script(self, data):
        file_path_escaped = data.get('file_path', '').replace('\\', '/')
        version_name = data.get('version_name', 'mm_import')
        python_command = f"""
import hou
try:
    pane = hou.ui.paneTabUnderCursor()
    if not pane or pane.type().name() != "NetworkEditor":
        raise Exception("Drop must be in a network editor pane.")
    network_node = pane.pwd()
    if network_node.isInsideLockedHDA():
        hou.ui.displayMessage("Cannot create nodes inside a locked asset.", severity=hou.severityType.Error)
    else:
        version_name = "{version_name}"
        file_path = r"{file_path_escaped}"
        sop_create_node = network_node.createNode("sopcreate", version_name)
        sop_create_node.setPosition(pane.cursorPosition())
        inner_sop_net = sop_create_node.node("sopnet/create")
        cam_importer_name = version_name + "_cam"
        cam_importer = inner_sop_net.createNode("yu.dong::Usd_cam_import::1.0", cam_importer_name)
        cam_importer.parm("fileName").set(file_path)
        cam_importer.parm("getCam").pressButton()
        output_node = inner_sop_net.node("output0")
        if output_node:
            cam_importer.setPosition(output_node.position() + hou.Vector2(0, -1.0))
            cam_importer.setDisplayFlag(True)
        print(f"Successfully created '{{sop_create_node.path()}}' for matchmove.")
except Exception as e:
    import traceback
    traceback.print_exc()
    hou.ui.displayMessage(f"Failed to execute drop script: {{e}}", severity=hou.severityType.Error)
"""
        return python_command

    def generate_houdini_generic_drop_script(self, data):
        file_path = (data.get('file_path') or '').replace('\\', '/')
        node_label = data.get('version_name') or 'imported_asset'
        return f"""
import hou, re
pane = hou.ui.paneTabUnderCursor()
if not pane or pane.type().name() != "NetworkEditor":
    raise Exception("Drop in a NetworkEditor pane.")
net = pane.pwd()
if net.isInsideLockedHDA():
    hou.ui.displayMessage("Cannot create inside a locked asset.", severity=hou.severityType.Error)
else:
    path = r"{file_path}"
    name = re.sub(r"[^0-9a-zA-Z_]+", "_", "{node_label}")
    pos  = pane.cursorPosition()
    net_type = net.type().name()
    if net_type == "obj":
        geo = net.createNode("geo", f"GEO_{{name}}"); geo.setPosition(pos); net = geo; pos = hou.Vector2(0,0); net_type="geo"

    def show(n): n.setPosition(pos); n.setDisplayFlag(True); n.setCurrent(True, clear_all_selected=True)

    ext = path.lower().split('.')[-1] if '.' in path.lower() else ''
    if net_type in ("lopnet","stage"):
        if ext in ("usd","usda","usdc"):
            n = net.createNode("yu.dong::usd_lop_import", name); n.parm("filepath1").set(path); show(n)
        elif ext == "abc":
            n = net.createNode("sopcreate", name); s = n.node("sopnet/create")
            a = s.createNode("alembic","import_alembic"); a.parm("fileName").set(path); a.setDisplayFlag(True); show(n)
        elif ext == "obj" or path.lower().endswith(".bgeo.sc"):
            n = net.createNode("sopcreate", name); s = n.node("sopnet/create")
            if path.lower().endswith(".bgeo.sc"):
                f = s.createNode("filecache::2.0","import_bgeo"); f.parm("loadfromdisk").set(1); f.parm("filemethod").set("explicit"); f.parm("file").set(path); f.setDisplayFlag(True)
            else:
                f = s.createNode("file","import_obj"); f.parm("file").set(path); f.setDisplayFlag(True)
            show(n)
        else:
            hou.ui.displayMessage(f"Unsupported ext in LOP: {{ext}}", severity=hou.severityType.Warning)
    else:
        if ext in ("usd","usda","usdc"):
            n = net.createNode("usdimport", name); n.parm("filepath1").set(path); n.parm("purpose").set("render"); show(n)
        elif ext == "abc":
            n = net.createNode("alembic", name); n.parm("fileName").set(path); show(n)
        elif path.lower().endswith(".bgeo.sc"):
            n = net.createNode("filecache::2.0", name); n.parm("loadfromdisk").set(1); n.parm("filemethod").set("explicit"); n.parm("file").set(path); show(n)
        elif ext == "obj":
            n = net.createNode("file", name); n.parm("file").set(path); show(n)
        else:
            hou.ui.displayMessage(f"Unsupported ext in SOP: {{ext}}", severity=hou.severityType.Warning)
    """

    def _initialize_shotgun_connection(self):
        project_name = os.environ.get("HAL_PROJECT")
        if not project_name: print("ERROR: HAL_PROJECT environment variable not set."); return
        self.project_info['name'] = project_name
        try:
            self.sg = login_to_shotgun()
            if self.sg:
                project_entity = self.sg.find_one("Project", [["name", "is", project_name]], ["id"])
                if project_entity: self.project_info['id'] = project_entity['id']
                else: print(f"ERROR: Could not find project '{project_name}'.")
            else: print("ERROR: Failed to get ShotGrid connection.")
        except Exception as e: print(f"ShotGrid initialization error: {e}"); traceback.print_exc()

    def _apply_custom_styles(self):
        self.top_tab_bar.setStyleSheet("QTabBar::tab{background-color:#3c3c3c;color:#cccccc;padding:5px 20px;border:1px solid #555555;border-bottom:none;border-top-left-radius:5px;border-top-right-radius:5px}QTabBar::tab:hover{background-color:#4a4a4a;color:#ffffff}QTabBar::tab:selected{background-color:rgb(66,122,179);color:#ffffff;border-color:rgb(66,122,179)}")
        button_style="QPushButton{background-color:rgb(62,176,80);color:white;border:none;padding:3px 16px;border-radius:4px}QPushButton:hover{background-color:rgb(66,179,136)}QPushButton:pressed{background-color:#3e8e41}"
        self.refresh_btn.setStyleSheet(button_style); self.toggle_layout_btn.setStyleSheet(button_style); self.cancel_selection_btn.setStyleSheet(button_style)
        self.close_btn.setStyleSheet("QPushButton{background-color:rgb(163,39,50);color:white;border:none;padding:3px 16px;border-radius:4px}QPushButton:hover{background-color:rgb(176,44,55)}QPushButton:pressed{background-color:rgb(102,24,31)}")

    def setup_ui(self):
        self.top_level_layout=QtWidgets.QHBoxLayout(self); self.top_level_layout.setContentsMargins(0,0,0,0)
        self.main_splitter=QtWidgets.QSplitter(QtCore.Qt.Horizontal,self)
        self.top_level_layout.addWidget(self.main_splitter)
        self.left_panel_widget = QtWidgets.QWidget()
        self.left_panel_v_layout = QtWidgets.QVBoxLayout(self.left_panel_widget)
        self.top_tab_bar = QtWidgets.QTabBar(); self.top_tab_bar.addTab("Assets"); self.top_tab_bar.addTab("Shots")
        self.filter_stack = QtWidgets.QStackedWidget()
        self.filter_stack.setStyleSheet("QComboBox { margin-right: 5px; } QLabel { margin: 2px; padding-left: 3px;}")
        assets_filter_widget = QtWidgets.QWidget()
        assets_filter_layout = QtWidgets.QHBoxLayout(assets_filter_widget)
        assets_filter_layout.setContentsMargins(0,5,0,5)
        self.task_combo_assets = QtWidgets.QComboBox()
        self.category_combo_assets = QtWidgets.QComboBox()
        assets_filter_layout.addWidget(QtWidgets.QLabel("Task:"))
        assets_filter_layout.addWidget(self.task_combo_assets, 1)
        assets_filter_layout.addWidget(QtWidgets.QLabel("Category:"))
        assets_filter_layout.addWidget(self.category_combo_assets, 1)
        self.filter_stack.addWidget(assets_filter_widget)
        shots_filter_widget = QtWidgets.QWidget()
        shots_filter_layout = QtWidgets.QHBoxLayout(shots_filter_widget)
        shots_filter_layout.setContentsMargins(0,5,0,5)
        self.task_combo_shots = QtWidgets.QComboBox()
        self.sequence_combo_shots = QtWidgets.QComboBox()
        self.shot_combo_shots = QtWidgets.QComboBox()
        shots_filter_layout.addWidget(QtWidgets.QLabel("Task:"))
        shots_filter_layout.addWidget(self.task_combo_shots, 1)
        shots_filter_layout.addWidget(QtWidgets.QLabel("Sequence:"))
        shots_filter_layout.addWidget(self.sequence_combo_shots, 1)
        shots_filter_layout.addWidget(QtWidgets.QLabel("Shot:"))
        shots_filter_layout.addWidget(self.shot_combo_shots, 1)
        self.filter_stack.addWidget(shots_filter_widget)
        self.scroll_area = QtWidgets.QScrollArea()
        self.scroll_area.setWidgetResizable(True)
        self.scroll_area.setStyleSheet("QScrollArea { border: 1px solid #444; border-radius: 4px; background-color: #2a2a2a; }")
        controls_layout = QtWidgets.QHBoxLayout()
        self.refresh_btn = QtWidgets.QPushButton("Refresh")
        self.toggle_layout_btn = QtWidgets.QPushButton("切换布局")
        self.cancel_selection_btn = QtWidgets.QPushButton("取消选择")
        self.close_btn = QtWidgets.QPushButton("Close")
        controls_layout.addWidget(self.refresh_btn); controls_layout.addWidget(self.toggle_layout_btn)
        controls_layout.addWidget(self.cancel_selection_btn); controls_layout.addStretch(); controls_layout.addWidget(self.close_btn)
        self.left_panel_v_layout.addWidget(self.top_tab_bar)
        self.left_panel_v_layout.addWidget(self.filter_stack)
        self.left_panel_v_layout.addWidget(self.scroll_area, 1)
        self.left_panel_v_layout.addLayout(controls_layout)
        self.main_splitter.addWidget(self.left_panel_widget)
        self.options_widget = QtWidgets.QWidget()
        self.setup_options_panel(self.options_widget)
        self.main_splitter.addWidget(self.options_widget)
        self.main_splitter.setSizes([800, 400])
        self.top_tab_bar.currentChanged.connect(self._on_main_tab_changed)
        self.sequence_combo_shots.currentIndexChanged.connect(self._on_sequence_changed)
        self.close_btn.clicked.connect(self.close)
        self.refresh_btn.clicked.connect(self._handle_refresh)
        self.toggle_layout_btn.clicked.connect(self._toggle_layout_orientation)
        self.cancel_selection_btn.clicked.connect(self._handle_cancel_selection)
        self._apply_custom_styles()

    def _on_main_tab_changed(self, index):
        self._handle_cancel_selection()
        self._setup_simple_scroll_content(None)
        self.filter_stack.setCurrentIndex(index)
        if index == 0:
            self.task_combo_assets.clear(); self.task_combo_assets.addItems(self.ASSET_TYPES)
            self.category_combo_assets.clear(); self.category_combo_assets.addItems(self.HAL_CATEGORY_TYPES)
        else:
            self.task_combo_shots.clear(); self.task_combo_shots.addItems(self.SHOT_TYPES)
            seq_codes, shots_nested = self._get_sequences_and_shots_from_sg()
            self.shots_data.clear()
            for i, seq in enumerate(seq_codes):
                self.shots_data[seq] = shots_nested[i]
            self.sequence_combo_shots.blockSignals(True)
            self.sequence_combo_shots.clear(); self.sequence_combo_shots.addItems(seq_codes)
            self.sequence_combo_shots.blockSignals(False)
            self._on_sequence_changed()

    def _on_sequence_changed(self):
        selected_sequence = self.sequence_combo_shots.currentText()
        if not selected_sequence:
            self.shot_combo_shots.clear(); return
        shots = self.shots_data.get(selected_sequence, [])
        shot_display_names = [s.replace(f"{selected_sequence}_", "", 1) if s.startswith(f"{selected_sequence}_") else s for s in shots]
        self.shot_combo_shots.clear()
        self.shot_combo_shots.addItem("All")
        self.shot_combo_shots.addItems(sorted(shot_display_names))

    def _handle_refresh(self):
            try:
                self._handle_cancel_selection()
                query_context = ""
                entity_type = ""  # <-- 新增一个变量来存储实体类型

                is_shot_context = self.top_tab_bar.currentIndex() == 1
                if is_shot_context:
                    entity_type = "Shot"  # <-- 如果是 Shots 标签，则类型是 "Shot"
                    task, seq = self.task_combo_shots.currentText(), self.sequence_combo_shots.currentText()
                    if task and seq:
                        query_context = f"{task}/{seq}"
                else:
                    entity_type = "Asset"  # <-- 否则类型是 "Asset"
                    task, cat = self.task_combo_assets.currentText(), self.category_combo_assets.currentText()
                    if task and cat:
                        query_context = f"{task}/{cat}"

                if not query_context:
                    self._setup_simple_scroll_content(None)
                    return

                # <-- 修改调用方式，传入新的 entity_type 参数
                all_versions = self.data_manager.find_files(query_context, entity_type=entity_type)
                
                if is_shot_context:
                    shot_display = self.shot_combo_shots.currentText()
                    seq = self.sequence_combo_shots.currentText()
                    if shot_display and shot_display != "All":
                        full_shot_name = f"{seq}_{shot_display}"
                        all_versions = [v for v in all_versions if v.get('entity', {}).get('name') == full_shot_name]
                
                for version in all_versions:
                    raw_path_data = version.get('sg_path_to_geometry')
                    version['sg_path_to_geometry'] = self._flatten_and_clean_paths(raw_path_data)
                
                self.all_versions_for_context = all_versions
                self._apply_filters()
                
            except Exception as e:
                traceback.print_exc()

    def _setup_simple_scroll_content(self, versions_data=None):
        scroll_content_widget = QtWidgets.QWidget()
        content_layout = QtWidgets.QGridLayout(scroll_content_widget)
        content_layout.setAlignment(QtCore.Qt.AlignTop | QtCore.Qt.AlignLeft)
        content_layout.setContentsMargins(10,10,10,10); content_layout.setSpacing(10)
        self.scroll_area.setWidget(scroll_content_widget)

        if not versions_data:
            label = QtWidgets.QLabel("请选择筛选条件并点击 [Refresh] 按钮加载数据"); label.setAlignment(QtCore.Qt.AlignCenter)
            content_layout.addWidget(label,0,0,1,1)
            return

        column_count = max(1, self.left_panel_widget.width() // (self.current_thumbnail_size[0] + 15))
        for i, version in enumerate(versions_data):
            # --- START: NEW DISPLAY NAME LOGIC ---
            is_shot_context = self.top_tab_bar.currentIndex() == 1
            if is_shot_context:
                current_ui_task = self.task_combo_shots.currentText()
            else:
                current_ui_task = self.task_combo_assets.currentText()

            entity = version.get('entity', {})
            entity_name = entity.get('name', '')

            # 使用从UI下拉菜单获取的 current_ui_task，而不是 self.hal_task
            if entity_name and current_ui_task:
                display_name = f"{entity_name}_{current_ui_task}"
            else:
                display_name = version.get('code', 'N/A')
            
            version['display_name'] = display_name
            # --- END: NEW DISPLAY NAME LOGIC ---

            image_prefix = version.get('image')
            found_thumb_path = None
            geo_paths = version.get('sg_path_to_geometry', [])
            for path in geo_paths:
                if not isinstance(path, str) or not path: continue
                try:
                    thumb_folder = os.path.join(os.path.dirname(path), "_SGthumbnail")
                    if image_prefix and os.path.isdir(thumb_folder):
                        for f in os.listdir(thumb_folder):
                            if f.startswith(image_prefix) and f.lower().endswith('.png'):
                                found_thumb_path = os.path.join(thumb_folder, f)
                                break
                    if found_thumb_path: break
                except Exception as e:
                    print(f"Warning: Could not process path '{path}': {e}")
            version['image_path'] = found_thumb_path

            thumb_widget = CustomThumbnailWidget(version, self.current_thumbnail_size, self)
            thumb_widget.clicked.connect(self._handle_thumbnail_click)
            content_layout.addWidget(thumb_widget, i // column_count, i % column_count)

    def setup_options_panel(self, parent_widget):
        layout = QtWidgets.QVBoxLayout(parent_widget); layout.setContentsMargins(9,9,9,9)
        title = QtWidgets.QLabel("Options"); title.setAlignment(QtCore.Qt.AlignCenter); title.setStyleSheet("font-weight: bold; font-size: 14px; padding-bottom: 5px;")
        layout.addWidget(title)
        import_group = QtWidgets.QGroupBox("导入设置"); import_layout = QtWidgets.QGridLayout(import_group)
        import_layout.addWidget(QtWidgets.QLabel("格式筛选:"), 0, 0); self.render_combo = QtWidgets.QComboBox(); import_layout.addWidget(self.render_combo, 0, 1)
        self.asset_filter_widget = QtWidgets.QWidget()
        asset_filter_layout = QtWidgets.QHBoxLayout(self.asset_filter_widget); asset_filter_layout.setContentsMargins(0,0,0,0)
        asset_filter_layout.addWidget(QtWidgets.QLabel("资产筛选:")); self.asset_filter_combo = QtWidgets.QComboBox(); asset_filter_layout.addWidget(self.asset_filter_combo)
        import_layout.addWidget(self.asset_filter_widget, 1, 0, 1, 2)
        import_layout.addWidget(QtWidgets.QLabel("版本筛选:"), 2, 0); self.material_combo = QtWidgets.QComboBox(); self.material_combo.setMaxVisibleItems(20); import_layout.addWidget(self.material_combo, 2, 1)
        import_layout.addWidget(QtWidgets.QLabel("工程文件路径:"), 3, 0); self.file_path_label = QtWidgets.QLabel("N/A"); self.file_path_label.setTextInteractionFlags(QtCore.Qt.TextSelectableByMouse); self.file_path_label.setWordWrap(True); import_layout.addWidget(self.file_path_label, 3, 1)
        import_layout.addWidget(QtWidgets.QLabel("Publish日期:"), 4, 0); self.publish_date_label = QtWidgets.QLabel("N/A"); self.publish_date_label.setTextInteractionFlags(QtCore.Qt.TextSelectableByMouse); import_layout.addWidget(self.publish_date_label, 4, 1)
        import_layout.addWidget(QtWidgets.QLabel("名称筛选:"), 5, 0); self.name_filter_edit = QtWidgets.QLineEdit(); self.name_filter_edit.setPlaceholderText("Filter by name..."); import_layout.addWidget(self.name_filter_edit, 5, 1)
        layout.addWidget(import_group)
        layout_group = QtWidgets.QGroupBox("布局设置")
        layout_form = QtWidgets.QFormLayout(layout_group)
        self.size_slider = QtWidgets.QSlider(QtCore.Qt.Horizontal)
        self.size_slider.setRange(0, len(self.THUMB_SIZES) - 1)
        self.size_slider.setValue(self.DEFAULT_THUMB_SIZE_INDEX)
        layout_form.addRow("缩略图大小:", self.size_slider)
        layout.addWidget(layout_group)
        self.houdini_fallback_group = QtWidgets.QGroupBox("HOUDINI导入备用")
        fallback_layout_h = QtWidgets.QVBoxLayout(self.houdini_fallback_group)
        fallback_msg = QtWidgets.QLabel("如果拖拽失效，请根据当前格式创建对应节点，\n然后选中节点并点击下方按钮。")
        fallback_msg.setWordWrap(True); fallback_msg.setStyleSheet("font-size: 9pt; color: #999999;")
        fallback_layout_h.addWidget(fallback_msg)
        self.manual_import_btn_h = QtWidgets.QPushButton("导入文件到选中Houdini节点")
        fallback_layout_h.addWidget(self.manual_import_btn_h)
        layout.addWidget(self.houdini_fallback_group)
        self.manual_import_btn_h.clicked.connect(self._handle_manual_import_houdini)
        self.maya_fallback_group = QtWidgets.QGroupBox("MAYA导入备用")
        fallback_layout_m = QtWidgets.QVBoxLayout(self.maya_fallback_group)

        maya_fallback_label = QtWidgets.QLabel("如果拖拽失效，请选择版本和格式后点击下方按钮。")
        maya_fallback_label.setWordWrap(True); maya_fallback_label.setStyleSheet("font-size: 9pt; color: #999999;")
        fallback_layout_m.addWidget(maya_fallback_label)

        self.manual_import_btn_m = QtWidgets.QPushButton("导入文件到Maya场景")
        fallback_layout_m.addWidget(self.manual_import_btn_m)
        self.manual_import_btn_m.clicked.connect(self._handle_manual_import_maya)

        self.reference_btn_m = QtWidgets.QPushButton("引用文件到Maya场景")
        fallback_layout_m.addWidget(self.reference_btn_m)
        self.reference_btn_m.clicked.connect(self._handle_reference_maya)

        layout.addWidget(self.maya_fallback_group)
        self.houdini_fallback_group.setVisible(CURRENT_DCC == "Houdini")
        self.maya_fallback_group.setVisible(CURRENT_DCC == "Maya")
        layout.addStretch()
        self.render_combo.currentIndexChanged.connect(self._update_dependent_filters)
        self.asset_filter_combo.currentIndexChanged.connect(self._update_dependent_filters)
        self.material_combo.currentIndexChanged.connect(self._update_displayed_info)
        self.name_filter_edit.textChanged.connect(self._apply_filters)
        self.size_slider.valueChanged.connect(self._update_thumbnail_size)

    def _get_sequences_and_shots_from_sg(self):
        if not self.sg or not self.project_info.get('id'): return [], []
        try:
            proj_filter = ['project', 'is', {'type': 'Project', 'id': self.project_info['id']}]
            sequences = self.sg.find("Sequence", [proj_filter], ['code'])
            if not sequences: return [], []
            seq_map = {s['code']: [] for s in sequences}
            seq_ids = [s['id'] for s in sequences]
            shots = self.sg.find("Shot", [proj_filter, ['sg_sequence', 'in', [{'type': 'Sequence', 'id': sid} for sid in seq_ids]]], ['code', 'sg_sequence'])
            for shot in shots:
                seq_code = shot.get('sg_sequence', {}).get('name')
                if seq_code in seq_map: seq_map[seq_code].append(shot['code'])
            sorted_codes = sorted(seq_map.keys())
            return sorted_codes, [sorted(seq_map[c]) for c in sorted_codes]
        except Exception as e:
            traceback.print_exc(); return [], []

    def _toggle_layout_orientation(self):
        self.main_splitter.setOrientation(QtCore.Qt.Vertical if self.main_splitter.orientation()==QtCore.Qt.Horizontal else QtCore.Qt.Horizontal)

    def _handle_thumbnail_click(self, widget: CustomThumbnailWidget):
        if self.currently_selected_widget == widget: return
        if self.currently_selected_widget: self.currently_selected_widget.set_selected(False)
        self.currently_selected_widget = widget
        self.currently_selected_widget.set_selected(True)
        self._query_and_populate_all_filters(widget)

    def _handle_cancel_selection(self):
        if self.currently_selected_widget:
            try: self.currently_selected_widget.set_selected(False)
            except RuntimeError: pass
            finally: self.currently_selected_widget = None
        self.asset_filter_widget.setVisible(False)
        for combo in [self.asset_filter_combo, self.material_combo, self.render_combo]:
            combo.blockSignals(True); combo.clear(); combo.blockSignals(False)
        self.current_version_history = []
        self._update_displayed_info()

    def _get_version_history_from_shotgun(self, widget: CustomThumbnailWidget):
        if not self.sg: return []
        version_data = widget.version_data
        project_id = self.project_info.get('id')
        entity = version_data.get('entity')
        if not all([project_id, entity, entity.get('id')]): return []
        parent_entity_id = int(entity['id']); parent_entity_type = entity.get('type')
        if self.top_tab_bar.currentIndex() == 0:
            task_name = self.task_combo_assets.currentText()
        else:
            task_name = self.task_combo_shots.currentText()
        if not task_name: return []
        try:
            filters = [
                ['project', 'is', {'type': 'Project', 'id': int(project_id)}],
                ['entity', 'is', {'type': parent_entity_type, 'id': parent_entity_id}],
                ['code', 'contains', f'_{task_name}_']
            ]
            fields = ['id', 'code', 'sg_path_to_geometry', 'entity', 'user', 'created_at', 'content']
            return self.sg.find('Version', filters, fields, order=[{'field_name': 'created_at', 'direction': 'desc'}])
        except Exception as e:
            traceback.print_exc(); return []

    def _get_file_format(self, file_path:str)->str:
        if not file_path or not isinstance(file_path,str): return "unknown"
        lower_path = file_path.lower()
        if lower_path.endswith('.bgeo.sc'): return "bgeo.sc"
        if lower_path.endswith('.vdb'): return "vdb"
        if lower_path.endswith('.obj'): return "obj"
        return lower_path.rsplit('.',1)[-1] if '.' in lower_path else "unknown"

    def _flatten_and_clean_paths(self, data):
        if isinstance(data, str):
            data = data.strip()
            if (data.startswith('[') and data.endswith(']')) or (data.startswith('(') and data.endswith(')')):
                try: return self._flatten_and_clean_paths(ast.literal_eval(data))
                except (ValueError, SyntaxError): return [data.strip('\'" ')]
            else: return [data.strip('\'" ')]
        elif isinstance(data, (list, tuple)):
            cleaned_list = []
            for item in data: cleaned_list.extend(self._flatten_and_clean_paths(item))
            return cleaned_list
        return []

    def _extract_version_from_path(self, path):
        if not path or not isinstance(path, str): return None
        match = re.search(r'[/_](v\d+)', path)
        if match: return match.group(1)
        return None

    def _query_and_populate_all_filters(self, widget: CustomThumbnailWidget):
        self.current_version_history = self._get_version_history_from_shotgun(widget)
        if not self.current_version_history:
            self._handle_cancel_selection(); return
        all_formats = set()
        for v in self.current_version_history:
            v['sg_path_to_geometry'] = self._flatten_and_clean_paths(v.get('sg_path_to_geometry'))
            code = v.get('code', '')
            match = re.match(r'^(.*)_v(\d{3})_([a-zA-Z]{3})(-.*)?$', code)
            if match:
                content, ver, art, asset = match.groups()
                v['base_name'] = f"{content}_v{ver}_{art}"
                v['asset_name'] = asset[1:] if asset else None
            else:
                v['base_name'] = code
                v['asset_name'] = None
            for path in v.get('sg_path_to_geometry', []):
                fmt = self._get_file_format(path)
                if fmt != "unknown": all_formats.add(fmt)
        self.render_combo.blockSignals(True)
        self.render_combo.clear()
        self.render_combo.addItems(sorted(list(all_formats)))
        self.render_combo.blockSignals(False)
        self._update_dependent_filters()

    def _update_dependent_filters(self):
        selected_format = self.render_combo.currentText()
        if not self.current_version_history: return

        versions_in_format = [v for v in self.current_version_history if any(self._get_file_format(p) == selected_format for p in v.get('sg_path_to_geometry', []))]
        assets_in_format = {v['asset_name'] for v in versions_in_format if v['asset_name']}

        self.asset_filter_combo.blockSignals(True)
        previous_asset_selection = self.asset_filter_combo.currentText()
        self.asset_filter_combo.clear()
        if assets_in_format:
            self.asset_filter_widget.setVisible(True)
            self.asset_filter_combo.addItems(sorted(list(assets_in_format)))
            self.asset_filter_combo.addItem(self.NO_ASSET_FILTER_TAG)
            if self.asset_filter_combo.findText(previous_asset_selection) > -1:
                self.asset_filter_combo.setCurrentText(previous_asset_selection)
        else:
            self.asset_filter_widget.setVisible(False)
        self.asset_filter_combo.blockSignals(False)

        selected_asset = self.asset_filter_combo.currentText() if self.asset_filter_widget.isVisible() else None

        final_versions = []
        if selected_asset:
            if selected_asset == self.NO_ASSET_FILTER_TAG:
                final_versions = [v for v in versions_in_format if v['asset_name'] is None]
            else:
                final_versions = [v for v in versions_in_format if v['asset_name'] == selected_asset]
        else:
            final_versions = versions_in_format

        # --- MODIFICATION 1: Sort by publish date (newest first) ---
        final_versions.sort(key=lambda v: v.get('created_at'), reverse=True)

        self.material_combo.blockSignals(True)
        self.material_combo.clear()

        # --- MODIFICATION 2: Generate display name from file path version ---
        for v in final_versions:
            original_code = v.get('code', 'N/A')
            display_name = original_code  # Start with the original name as a fallback

            # Find the specific file path for the currently selected format
            paths = v.get('sg_path_to_geometry', [])
            path_for_format = next((p for p in paths if self._get_file_format(p) == selected_format), None)

            if path_for_format:
                # Extract the version string (e.g., "v002") from the file path
                path_version = self._extract_version_from_path(path_for_format)
                
                if path_version:
                    # Use regex to replace the version part in the original code
                    # e.g., replace "_v003" in "..._v003_yud" with "_v002"
                    display_name = re.sub(r'_v\d+', f'_{path_version}', original_code, 1)

            self.material_combo.addItem(display_name, userData=v)
        # --- END OF MODIFICATIONS ---

        self.material_combo.blockSignals(False)
        self._update_displayed_info()

    def _update_displayed_info(self):
        data = self.material_combo.currentData()
        if not data:
            self.file_path_label.setText("N/A")
            self.publish_date_label.setText("N/A")
            return
        created_at = data.get('created_at')
        self.publish_date_label.setText(created_at.strftime("%m/%d/%y %I:%M%p") if created_at else "N/A")
        self._update_file_path_label()

    def _update_file_path_label(self):
        data = self.material_combo.currentData()
        if not data:
            self.file_path_label.setText("N/A"); return
        selected_format = self.render_combo.currentText()
        paths = data.get('sg_path_to_geometry', [])
        found_path = next((p for p in paths if self._get_file_format(p) == selected_format), "N/A")
        self.file_path_label.setText(found_path)

    def _apply_filters(self):
        # --- FIX: Clear the selection reference before rebuilding UI ---
        # This prevents the "zombie widget" problem by ensuring we don't hold a
        # reference to a widget that is about to be deleted.
        self.currently_selected_widget = None
        # --- END FIX ---

        name_filter_text = self.name_filter_edit.text().lower()
        if not self.all_versions_for_context:
            filtered_versions = []
        elif not name_filter_text:
            filtered_versions = self.all_versions_for_context
        else:
            # Filter based on the full version name ('code')
            filtered_versions = [v for v in self.all_versions_for_context if name_filter_text in v.get('code', '').lower()]

        self._setup_simple_scroll_content(filtered_versions)

    def _update_thumbnail_size(self, value):
        if value < len(self.THUMB_SIZES):
            self.current_thumbnail_size = self.THUMB_SIZES[value]
            self._apply_filters()

    def _handle_manual_import_maya(self):
        if CURRENT_DCC != "Maya": return
        self.update_drag_info()
        data = self.get_current_drag_data()
        if not data.get('file_path') or data.get('file_path') == "N/A":
            cmds.warning("Please select a valid version and format to import.")
            return
        import_script = self.generate_maya_drop_script(data)
        try:
            mel.eval(import_script)
            cmds.inViewMessage(amg='<hl>文件已成功导入!</hl>', pos='midCenter', fade=True, fot=500)
        except Exception as e:
            cmds.error(f"Manual import failed: {e}"); traceback.print_exc()

    def _handle_reference_maya(self):
        if CURRENT_DCC != "Maya":
            return

        # Pull current selection from the right panel
        self.update_drag_info()
        data = self.get_current_drag_data()

        file_path = (data.get('file_path') or "").strip()
        if not file_path or file_path == "N/A":
            try:
                import maya.cmds as cmds
                cmds.warning("请先选择有效的版本、格式，并确保右侧显示了工程文件路径。")
            except Exception:
                pass
            return

        # prefer asset_filter_name; fallback to version
        asset_name = data.get('asset_filter_name') or data.get('version_name') or "referenced_asset"
        file_format = (data.get('format') or "").lower()

        # Safe import inside Maya
        import maya.cmds as cmds

        def _ensure_plugin(name):
            if not cmds.pluginInfo(name, q=True, loaded=True):
                try:
                    cmds.loadPlugin(name)
                except Exception as e:
                    cmds.error("加载插件失败: {} -> {}".format(name, e))

        try:
            if file_format in ("ma", "mb"):
                # Standard Maya reference
                cmds.file(
                    file_path,
                    reference=True,
                    ignoreVersion=True,
                    mergeNamespacesOnClash=False,
                    namespace=asset_name
                )
                cmds.inViewMessage(amg='<hl>引用成功: Maya 文件</hl>', pos='midCenter', fade=True, fot=500)

            elif file_format in ("usd", "usda", "usdc"):
                # USD "reference" in Maya is typically a ProxyShape pointing at the USD file
                _ensure_plugin("mayaUsdPlugin")

                # Create a transform + proxy shape (reference-like behavior, non-destructive)
                xform = cmds.createNode("transform", name=asset_name)
                shape = cmds.createNode("mayaUsdProxyShape", name=f"{asset_name}Shape", parent=xform)
                # Set file path
                try:
                    cmds.setAttr(f"{shape}.filePath", file_path, type="string")
                except Exception:
                    # Older builds might use 'filePath' or 'filePath' spelling variations; the above is current
                    cmds.warning("无法设置 mayaUsdProxyShape.filePath 属性，请检查 MayaUSD 版本。")
                # Optional: read anim etc. (MayaUSD varies by version; keep simple & robust)
                cmds.select(xform, r=True)
                cmds.inViewMessage(amg='<hl>引用成功: USD（通过 ProxyShape）</hl>', pos='midCenter', fade=True, fot=500)

            elif file_format == "abc":
                # Alembic can be referenced as a file reference with type='Alembic'
                _ensure_plugin("AbcImport")
                # In many pipelines, Alembic "reference" behaves like a file reference that instantiates an AlembicNode
                cmds.file(
                    file_path,
                    reference=True,
                    type="Alembic",
                    ignoreVersion=True,
                    mergeNamespacesOnClash=False,
                    namespace=asset_name,
                    options=" -rebuildAll "  # safe default; adjust if your studio uses specific flags
                )
                cmds.inViewMessage(amg='<hl>引用成功: Alembic</hl>', pos='midCenter', fade=True, fot=500)

            elif file_format == "vdb":
                # VDB typically isn't a file reference in Maya; use aiVolume node pointing at the file.
                _ensure_plugin("mtoa")
                vol_shape = cmds.createNode("aiVolume")
                # Display "####" in UI but store the literal pattern if present
                display_path = file_path.replace('$F4', '####')
                cmds.setAttr(f"{vol_shape}.filename", display_path, type="string")
                # Turn on frame extension if needed
                if '$F' in file_path or '####' in file_path:
                    cmds.setAttr(f"{vol_shape}.useFrameExtension", 1)
                xform = cmds.listRelatives(vol_shape, parent=True, f=True)[0]
                try:
                    cmds.rename(xform, asset_name)
                except Exception:
                    pass
                cmds.select(xform, r=True)
                cmds.inViewMessage(amg='<hl>已创建 aiVolume 指向 VDB（非文件引用）</hl>', pos='midCenter', fade=True, fot=500)

            elif file_format == "obj":
                # Maya doesn't support referencing OBJ as a live "reference"; fall back to import
                cmds.warning("OBJ 不支持作为文件引用，将执行导入。")
                try:
                    cmds.file(file_path, i=True, ignoreVersion=True, groupReference=True, groupName=asset_name)
                    cmds.inViewMessage(amg='<hl>已导入 OBJ（参考不支持）</hl>', pos='midCenter', fade=True, fot=500)
                except Exception as e:
                    cmds.error(f"导入 OBJ 失败: {e}")

            else:
                cmds.warning(f"不支持的引用格式: {file_format}")

        except Exception as e:
            import traceback
            print(traceback.format_exc())
            cmds.error(f"引用失败: {e}")


    def _handle_manual_import_houdini(self):
        if CURRENT_DCC != "Houdini": return
        selected = hou.selectedNodes()
        if not selected:
            hou.ui.displayMessage("请先选中一个 Null 节点。", title="操作失败", severity=hou.severityType.Error)
            return
        if len(selected) > 1:
            hou.ui.displayMessage("请只选中一个 Null 节点。", title="操作失败", severity=hou.severityType.Error)
            return
        selected_null = selected[0]
        if selected_null.type().name() != "null":
            hou.ui.displayMessage("请选择一个 'null' 节点作为标记。", title="操作失败", severity=hou.severityType.Error)
            return
        parent_net = selected_null.parent(); pos = selected_null.position()
        self.update_drag_info(); data = self.get_current_drag_data()
        version_name, file_path, file_format = data.get('version_name'), data.get('file_path'), data.get('format')
        if not version_name or not file_path or file_path == "N/A":
            hou.ui.displayMessage("请先在UI中选择有效的版本和文件。", title="操作失败", severity=hou.severityType.Error)
            return
        
        is_lop = selected_null.type().category().name() == "Lop"
        is_sop = selected_null.type().category().name() == "Sop"
        is_obj = selected_null.type().category().name() == "Object"

        try:
            final_node = None
            if is_lop:
                if file_format in ("usd", "usda", "usdc"):
                    new_node = parent_net.createNode("yu.dong::usd_lop_import", version_name)
                    new_node.parm("filepath1").set(file_path)
                    final_node = new_node
                elif file_format in ("abc", "bgeo.sc", "vdb", "obj"):
                    sop_create = parent_net.createNode("sopcreate", version_name)
                    internal_sop = sop_create.node("sopnet/create")
                    node_map = {"abc": "alembic", "bgeo.sc": "file", "vdb": "file", "obj": "file"}
                    inner_node = internal_sop.createNode(node_map[file_format], version_name)
                    if file_format == "bgeo.sc":
                        inner_node.parm("file").set(file_path)
                    else:
                        inner_node.parm("fileName" if file_format == "abc" else "file").set(file_path)
                    output = internal_sop.node("output0")
                    if output: output.setInput(0, inner_node)
                    inner_node.setDisplayFlag(True)
                    final_node = sop_create
            elif is_sop or is_obj:
                parent_for_node = parent_net if is_sop else parent_net.createNode("geo", version_name)
                final_node = parent_for_node if is_obj else None
                node_map = {"usd": "usdimport", "abc": "alembic", "bgeo.sc": "file", "vdb": "file", "obj": "file",
                "usda": "usdimport", "usdc": "usdimport"}

                node_type_to_create = node_map.get(file_format) 
                inner_node = parent_for_node.createNode(node_type_to_create, version_name) if node_type_to_create else None

                if inner_node:
                    if file_format == "bgeo.sc":
                        inner_node.parm("file").set(file_path)
                    elif file_format == "usd":
                        inner_node.parm("filepath1").set(file_path)
                    elif file_format == "abc":
                        inner_node.parm("fileName").set(file_path)
                    elif file_format == "usda":
                        inner_node.parm("filepath1").set(file_path)
                    elif file_format == "usdc":
                        inner_node.parm("filepath1").set(file_path)
                    else: # 包含了 vdb, obj 等其他使用 "file" 参数的格式
                        inner_node.parm("file").set(file_path)
                    
                    if not final_node: final_node = inner_node
                else: 
                    hou.ui.displayMessage(f"不支持的格式 '{file_format}'。", severity=hou.severityType.Error)
                    if is_obj: parent_for_node.destroy()

            if final_node:
                final_node.setPosition(pos)
                selected_null.destroy()
                final_node.setDisplayFlag(True)
                final_node.setCurrent(True, clear_all_selected=True)
                hou.ui.displayMessage(f"成功导入到节点 '{final_node.name()}'！", title="导入成功")
        except Exception as e:
            traceback.print_exc()
            hou.ui.displayMessage(f"导入失败: {e}", title="错误", severity=hou.severityType.Error)